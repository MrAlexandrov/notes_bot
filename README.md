# Telegram Notes Bot

Телеграм-бот для сохранения текстовых сообщений в дневные заметки Obsidian.

## Возможности

- Принимает текстовые сообщения от авторизованного пользователя
- Сохраняет сообщения в дневные заметки (Daily notes) в формате Obsidian
- Автоматически создает новые дневные заметки из шаблона `Templates/Daily.md`
- Если заметка за день уже существует, добавляет сообщение в конец файла
- Заметки сохраняются в папку `Daily/` в формате `dd-Mmm-yyyy.md` (например, `09-Nov-2025.md`)
- Поддерживает интеграцию с существующим хранилищем Obsidian
- Команды для получения заметок:
  - `/today` - получить заметку текущего дня
  - `/get dd-Mmm-yyyy` - получить заметку указанного дня

## Установка и запуск

### 1. Создайте Telegram бота

1. Найдите [@BotFather](https://t.me/botfather) в Telegram
2. Отправьте команду `/newbot`
3. Следуйте инструкциям и получите токен бота
4. Узнайте свой Telegram ID (можно через [@userinfobot](https://t.me/userinfobot))

### 2. Настройте окружение

Создайте файл `.env` на основе `.env.example`:

```bash
cp .env.example .env
```

Отредактируйте `.env` и укажите **все обязательные параметры**:

```bash
# Telegram Bot Configuration
BOT_TOKEN=your_bot_token_here
ROOT_ID=your_telegram_id_here

# Obsidian Vault Configuration (REQUIRED)
OBSIDIAN_VAULT_PATH=/path/to/your/obsidian/vault

# Notes Configuration (REQUIRED)
NOTES_DIR=/notes
TEMPLATE_DIR=/notes/Templates
```

**Параметры:**
- `BOT_TOKEN` - токен вашего бота от BotFather (обязательно)
- `ROOT_ID` - ваш Telegram ID (обязательно)
- `OBSIDIAN_VAULT_PATH` - **полный путь** к вашему хранилищу Obsidian на хост-машине (обязательно)
- `NOTES_DIR` - путь внутри контейнера, обычно `/notes` (обязательно)
- `TEMPLATE_DIR` - путь к шаблонам внутри контейнера, обычно `/notes/Templates` (обязательно)

**Примеры путей для `OBSIDIAN_VAULT_PATH`:**
- На локальном компьютере: `/Users/username/Yandex.Disk.localized/notes`
- На виртуальной машине: `/home/user/obsidian-vault`
- На Windows: `C:/Users/username/Documents/ObsidianVault`

### 3. Запустите бота с Docker

```bash
docker-compose up -d
```

### 4. Альтернативный запуск без Docker

Если хотите запустить бота локально без Docker:

```bash
# Установите Poetry, если еще не установлен
curl -sSL https://install.python-poetry.org | python3 -

# Установите зависимости
poetry install

# Настройте переменные окружения для локального запуска
export NOTES_DIR="/path/to/your/obsidian/notes"
export TEMPLATE_DIR="/path/to/your/obsidian/notes/Templates"

# Запустите бота
poetry run python main.py
# или используя make
make run
```

### 5. Проверьте работу

Отправьте любое текстовое сообщение боту в Telegram. Оно должно:
1. Создать новую дневную заметку из шаблона (если её ещё нет)
2. Или добавить сообщение в конец существующей заметки
3. Заметка будет сохранена в `Daily/dd-Mmm-yyyy.md`

## Использование

### Сохранение заметок

Просто отправьте текстовое сообщение боту - оно автоматически сохранится в заметку текущего дня.

### Команды

- `/today` - получить содержимое заметки текущего дня
  ```
  Пример: /today
  ```

- `/get <дата>` - получить содержимое заметки указанного дня
  ```
  Пример: /get 11-Oct-2025
  Пример: /get 25-Dec-2024
  ```

## Управление

### Просмотр логов

```bash
docker-compose logs -f
```

### Остановка бота

```bash
docker-compose down
```

### Перезапуск бота

```bash
docker-compose restart
```

### Обновление зависимостей

```bash
poetry update
```

## Структура проекта

```
telegram-notes-bot/
├── src/                  # Исходный код бота
│   ├── __init__.py      # Инициализация пакета
│   ├── bot.py           # Главный модуль бота
│   ├── config.py        # Конфигурация и настройки
│   ├── handlers.py      # Обработчики команд и сообщений
│   ├── notes.py         # Работа с заметками
│   └── utils.py         # Вспомогательные функции
├── main.py              # Точка входа в приложение
├── bot.py.old           # Старая версия (резервная копия)
├── pyproject.toml       # Poetry конфигурация и зависимости
├── poetry.lock          # Зафиксированные версии зависимостей
├── Makefile             # Команды для управления проектом
├── Dockerfile           # Docker образ
├── docker-compose.yml   # Docker Compose конфигурация
├── .env                 # Переменные окружения (создать вручную)
├── .env.example         # Шаблон для .env
├── .gitignore           # Игнорируемые файлы
└── notes/               # Папка с заметками (создается автоматически)
```

### Описание модулей

- **[`src/config.py`](src/config.py)** - Загрузка переменных окружения, настройка логирования, константы конфигурации
- **[`src/utils.py`](src/utils.py)** - Вспомогательные функции (генерация имени файла, экранирование Markdown)
- **[`src/notes.py`](src/notes.py)** - Функции для работы с заметками (сохранение и чтение)
- **[`src/handlers.py`](src/handlers.py)** - Обработчики команд `/today`, `/get` и текстовых сообщений
- **[`src/bot.py`](src/bot.py)** - Инициализация и запуск бота
- **[`main.py`](main.py)** - Точка входа в приложение

## Формат заметок

### Шаблон дневной заметки

Бот использует шаблон из `Templates/Daily.md`:

```markdown
---
date: "[[{{date:DD-MMM-YYYY}}]]"
title: "[[{{date:DD-MMM-YYYY}}]]"
tags:
  - daily
Оценка:
---
- [ ] Доброго утра!
- [ ] Заполнить дневник
---

```

### Пример созданной заметки

При создании новой заметки шаблон заполняется текущей датой. Например, `Daily/09-Nov-2025.md`:

```markdown
---
date: "[[09-Nov-2025]]"
title: "[[09-Nov-2025]]"
tags:
  - daily
Оценка:
---
- [ ] Доброго утра!
- [ ] Заполнить дневник
---

Первое сообщение от бота
Второе сообщение
Третье сообщение
```

Каждое новое сообщение добавляется в конец файла на новой строке.

## Технологии

- **Python 3.11** - язык программирования
- **Poetry** - управление зависимостями
- **python-telegram-bot** - библиотека для работы с Telegram Bot API
- **python-dotenv** - загрузка переменных окружения
- **Docker & Docker Compose** - контейнеризация

## Конфигурация

### Переменные окружения

Все переменные окружения **обязательны** и должны быть указаны в файле `.env`:

- `BOT_TOKEN` - токен Telegram бота (обязательно)
- `ROOT_ID` - ID авторизованного пользователя (обязательно)
- `OBSIDIAN_VAULT_PATH` - путь к хранилищу Obsidian на хост-машине (обязательно, только для Docker)
- `NOTES_DIR` - путь к хранилищу внутри контейнера (обязательно, обычно `/notes`)
- `TEMPLATE_DIR` - путь к папке с шаблонами (обязательно, обычно `/notes/Templates`)

**Важно:** Бот проверяет существование всех указанных путей при запуске и выдаст ошибку, если какой-то путь не найден или переменная не указана.

### Структура хранилища Obsidian

Бот ожидает следующую структуру:

```
obsidian-vault/
├── Daily/              # Папка с дневными заметками (создается автоматически)
│   ├── 09-Nov-2025.md
│   ├── 10-Nov-2025.md
│   └── ...
├── Templates/          # Папка с шаблонами
│   └── Daily.md       # Шаблон дневной заметки
└── ...                # Другие файлы и папки Obsidian
```

## Безопасность

- Бот обрабатывает сообщения только от пользователя с ID, указанным в `ROOT_ID`
- Файл `.env` с токенами не должен попадать в систему контроля версий
- При использовании Docker volume монтируется с правами на чтение и запись (`:rw`)
- Убедитесь, что у контейнера есть права на запись в примонтированную директорию