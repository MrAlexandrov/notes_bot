# Implementation Plan - Interactive Telegram Notes Bot

## Этапы реализации

### Этап 1: Подготовка инфраструктуры (Приоритет: Высокий)

#### 1.1 Создать систему управления состояниями
- [ ] Создать `src/states/context.py` с классами `UserState` и `UserContext`
- [ ] Создать `src/states/manager.py` с `StateManager`
- [ ] Добавить методы для получения/обновления контекста пользователя

#### 1.2 Реорганизовать структуру обработчиков
- [ ] Создать директорию `src/handlers/`
- [ ] Переместить существующий код в `src/handlers/commands.py`
- [ ] Создать `src/handlers/messages.py` для текстовых сообщений
- [ ] Создать `src/handlers/callbacks.py` для callback queries

#### 1.3 Создать систему клавиатур
- [ ] Создать директорию `src/keyboards/`
- [ ] Создать `src/keyboards/main_menu.py` для главного меню
- [ ] Создать `src/keyboards/tasks.py` для управления задачами
- [ ] Создать `src/keyboards/calendar.py` для календаря

### Этап 2: Главное меню (Приоритет: Высокий)

#### 2.1 Реализовать главное меню
- [ ] Создать функцию генерации главного меню в `keyboards/main_menu.py`
- [ ] Добавить кнопки: Оценка, Задачи, Заметка, Календарь
- [ ] Показывать активную дату в сообщении

#### 2.2 Обновить обработку текстовых сообщений
- [ ] При получении текста добавлять в активную заметку
- [ ] Отправлять подтверждение с главным меню
- [ ] Учитывать активную дату из контекста

#### 2.3 Добавить команду /start
- [ ] Показывать приветствие
- [ ] Отображать главное меню
- [ ] Инициализировать контекст пользователя

### Этап 3: Система оценок (Приоритет: Средний)

#### 3.1 Создать модуль оценок
- [ ] Создать `src/features/rating.py`
- [ ] Функция для обновления оценки в frontmatter
- [ ] Функция для чтения текущей оценки

#### 3.2 Реализовать callback обработчик
- [ ] Обработка `menu:rating`
- [ ] Переход в состояние `WAITING_RATING`
- [ ] Отправка сообщения с запросом оценки

#### 3.3 Реализовать обработку ввода оценки
- [ ] Валидация числа (0-10)
- [ ] Обновление frontmatter заметки
- [ ] Возврат в состояние `IDLE`
- [ ] Показ главного меню

### Этап 4: Управление задачами (Приоритет: Высокий)

#### 4.1 Создать модуль задач
- [ ] Создать `src/features/tasks.py`
- [ ] Функция парсинга задач из markdown
- [ ] Функция обновления статуса задачи
- [ ] Функция добавления новой задачи

#### 4.2 Реализовать отображение задач
- [ ] Создать клавиатуру с задачами в `keyboards/tasks.py`
- [ ] Добавить пагинацию (5 задач на страницу)
- [ ] Показывать статус задач (☐/☑)
- [ ] Кнопки навигации и добавления

#### 4.3 Реализовать callback обработчики
- [ ] `menu:tasks` - открыть список задач
- [ ] `task:toggle:N` - переключить задачу N
- [ ] `task:add` - начать добавление задачи
- [ ] `task:page:N` - переключить страницу
- [ ] `task:back` - вернуться в меню

#### 4.4 Реализовать добавление задач
- [ ] Переход в состояние `WAITING_NEW_TASK`
- [ ] Обработка текстового ввода
- [ ] Добавление задачи в файл
- [ ] Возврат к списку задач

### Этап 5: Календарная навигация (Приоритет: Высокий)

#### 5.1 Создать модуль календаря
- [ ] Создать `src/features/calendar.py`
- [ ] Функция генерации календаря месяца
- [ ] Функция проверки существования заметки
- [ ] Функция форматирования даты

#### 5.2 Реализовать клавиатуру календаря
- [ ] Создать `keyboards/calendar.py`
- [ ] Отображение дней месяца (7 колонок)
- [ ] Выделение текущей даты
- [ ] Выделение дат с заметками
- [ ] Навигация между месяцами

#### 5.3 Реализовать callback обработчики
- [ ] `menu:calendar` - открыть календарь
- [ ] `cal:prev` - предыдущий месяц
- [ ] `cal:next` - следующий месяц
- [ ] `cal:select:DATE` - выбрать дату
- [ ] `cal:today` - вернуться к сегодня
- [ ] `cal:back` - вернуться в меню

#### 5.4 Реализовать выбор даты
- [ ] Установка `active_date` в контексте
- [ ] Создание заметки если не существует
- [ ] Показ главного меню с новой активной датой

### Этап 6: Операции с заметками (Приоритет: Средний)

#### 6.1 Расширить модуль notes.py
- [ ] Функция чтения frontmatter
- [ ] Функция обновления frontmatter
- [ ] Функция получения содержимого без frontmatter
- [ ] Функция форматированного отображения заметки

#### 6.2 Реализовать показ заметки
- [ ] Callback `menu:note`
- [ ] Форматирование содержимого
- [ ] Экранирование для MarkdownV2
- [ ] Показ с главным меню

### Этап 7: Интеграция и тестирование (Приоритет: Высокий)

#### 7.1 Обновить bot.py
- [ ] Зарегистрировать все обработчики
- [ ] Добавить обработчик callback queries
- [ ] Добавить обработчик ошибок

#### 7.2 Тестирование
- [ ] Тест главного меню
- [ ] Тест системы оценок
- [ ] Тест управления задачами
- [ ] Тест календарной навигации
- [ ] Тест работы с разными датами
- [ ] Тест обработки ошибок

#### 7.3 Документация
- [ ] Обновить README.md
- [ ] Добавить примеры использования
- [ ] Документировать новые функции

### Этап 8: Улучшения (Приоритет: Низкий)

#### 8.1 Дополнительные функции
- [ ] Поиск по заметкам
- [ ] Статистика (количество задач, оценки)
- [ ] Экспорт заметок
- [ ] Напоминания

#### 8.2 UI улучшения
- [ ] Эмодзи для разных типов задач
- [ ] Цветовое выделение в календаре
- [ ] Анимации переходов

## Порядок реализации

### Фаза 1: Базовая инфраструктура (1-2 дня)
1. Система состояний
2. Реорганизация обработчиков
3. Система клавиатур
4. Главное меню

### Фаза 2: Основной функционал (2-3 дня)
1. Система оценок
2. Управление задачами
3. Календарная навигация

### Фаза 3: Полировка (1 день)
1. Операции с заметками
2. Тестирование
3. Документация

## Технические детали

### Структура callback_data

```python
# Максимальная длина: 64 байта
# Формат: action:param1:param2

CALLBACKS = {
    # Меню
    "menu:rating": "Поставить оценку",
    "menu:tasks": "Открыть задачи",
    "menu:note": "Показать заметку",
    "menu:calendar": "Открыть календарь",
    
    # Оценки
    "rating:cancel": "Отменить ввод оценки",
    
    # Задачи
    "task:toggle:{idx}": "Переключить задачу",
    "task:add": "Добавить задачу",
    "task:page:{n}": "Страница N",
    "task:back": "Назад",
    
    # Календарь
    "cal:prev": "Предыдущий месяц",
    "cal:next": "Следующий месяц",
    "cal:select:{date}": "Выбрать дату",
    "cal:today": "Сегодня",
    "cal:back": "Назад"
}
```

### Хранение состояний

```python
# В памяти (простое решение)
user_contexts: Dict[int, UserContext] = {}

# Для production можно использовать:
# - Redis
# - SQLite
# - PostgreSQL
```

### Обработка ошибок

```python
async def error_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Глобальный обработчик ошибок"""
    logger.error(f"Update {update} caused error {context.error}")
    
    if update.effective_message:
        await update.effective_message.reply_text(
            "❌ Произошла ошибка. Попробуйте /start"
        )
```

## Зависимости

### Новые библиотеки
```toml
# Уже есть
python-telegram-bot = "^20.0"
python-dotenv = "^1.0.0"

# Возможно понадобятся
pyyaml = "^6.0"  # Для парсинга frontmatter
```

## Миграция

### Обратная совместимость
- Сохранить команды `/today` и `/get`
- Добавить `/start` для нового интерфейса
- Постепенный переход пользователей

### Обновление существующих заметок
- Проверить формат frontmatter
- Добавить поле `Оценка:` если отсутствует
- Валидация структуры задач

## Метрики успеха

1. ✅ Все функции работают без ошибок
2. ✅ Время отклика < 1 секунды
3. ✅ Интуитивный интерфейс
4. ✅ Корректная работа с любыми датами
5. ✅ Правильное сохранение данных в Obsidian

## Риски и митигация

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Потеря состояния при перезапуске | Высокая | Средняя | Использовать персистентное хранилище |
| Конфликты при одновременном редактировании | Низкая | Высокая | Блокировки файлов |
| Переполнение callback_data | Средняя | Низкая | Короткие идентификаторы |
| Проблемы с парсингом markdown | Средняя | Средняя | Тщательное тестирование |

## Следующий шаг

Переключиться в режим Code и начать реализацию с Этапа 1.